---
title: "Analyses_manuscript"
author: "Lisa Lemmens"
date: "April 16, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
#Packages & function
##loading necessary packages
```{r, echo=FALSE, warning=FALSE}
library(data.table)
library(reshape2)
library(lme4)
library(readxl)
library("ggpubr")
library(segmented)
library(tidyverse)
library(ggplot2)
library(BayesFactor)
library(lmerTest)
library(cowplot)
library(psycho)

```

# Import data and data wrangling
## Read in the datafiles of each participant
```{r message=FALSE,echo=FALSE, warning=FALSE}
d_files_exp <- dir(path="Data/Exp/", pattern="*.csv", full.names = T)

read_data_exp<- function(x) {
  df <- read_csv(x)
  df<- mutate_all(df, as.character)
  return(df)
}



df <- bind_rows(lapply(d_files_exp, read_data_exp))
#df <- bind_rows(lapply(d_files_exp, read_data_exp))

#Participants in ASD group have a participant number < 100 & participants in the TD group have a participant number > 200
df$group[df$participant < 100] <- "ASD" 
df$group[df$participant > 200] <- "TD"

df$group=factor(df$group)
```

## Select necessary variables
```{r}
df_select <- df %>%
  dplyr::select(.,expName,participant,group,session,blockN, totBlockN, trialN,targetOri,targetPos, targetRow,distrMean,dtype,dsd,targetDist,prevDistrMean,streak_length_prime, seq_type,answer,rt, correct, d_ori_1, d_ori_2,d_ori_3, d_ori_4, d_ori_5, d_ori_6, d_ori_7, d_ori_8, d_ori_9, d_ori_10, d_ori_11, d_ori_12, d_ori_13, d_ori_14, d_ori_15, d_ori_16, d_ori_17, d_ori_18, d_ori_19, d_ori_20, d_ori_21, d_ori_22, d_ori_23, d_ori_24, d_ori_25, d_ori_26, d_ori_27, d_ori_28, d_ori_29, d_ori_30, d_ori_31, d_ori_32, d_ori_33, d_ori_34, d_ori_35) %>%
  dplyr::rename(subjectId=participant) %>%
  mutate(blockN= as.numeric(blockN), totBlockN = as.numeric(totBlockN), trialN = as.numeric(trialN),dsd = as.numeric(dsd), targetOri = as.numeric(targetOri), targetPos = as.numeric(targetPos), targetRow= as.numeric(targetRow), distrMean=as.numeric(distrMean), targetDist = as.numeric(targetDist),prevDistrMean = as.numeric(prevDistrMean), streak_length_prime=as.numeric(streak_length_prime), rt=as.numeric(rt), correct=as.numeric(correct))%>%  
  filter(!is.na(rt))

#function to calculate difference between two angles (from Andrey)
angle_dist_180<-function(a,b){
  c = a - b
  (c+90)%%180 - 90
}

# Variables
df_filter <- df_select %>%
  mutate(rt=rt*1000)%>% #Convert to ms instead of sec
  mutate(previous_correct = lag(correct)) %>% #Previous trial correct?
  mutate(previous_target = lag(targetOri))%>% #Previous target orientation?
  mutate(.,log_rt = log(rt)) %>% 
  mutate(ctpd= angle_dist_180(targetOri,prevDistrMean))%>% #CT-PD: difference between current target ori and previous distractor ori mean. 
  mutate(abs_ctpd = abs(ctpd))%>% #absolute value of CT-PD
  mutate(cdpt= angle_dist_180(distrMean,previous_target))%>% #CD-PT: difference between current distractor ori mean and previous target ori.
  mutate(abs_cdpt = abs(cdpt))%>% #absolute value of CD-PT
  mutate(ctpt = angle_dist_180(targetOri,previous_target))%>% #CT-PT: difference between current target ori mean and previous target ori.
  mutate(abs_ctpt = abs(ctpt)) %>%# absolute value of CT-PT
  mutate(cdpd = angle_dist_180(distrMean,prevDistrMean))%>% #CD-PD: difference between current distractor ori mean and previous distractor ori    mean.
  mutate(abs_cdpd = abs(cdpd))%>%
  mutate(targetDist_ang = angle_dist_180(distrMean,targetOri))%>%
  mutate(distrMean = ifelse(distrMean> 90, distrMean - 180, distrMean))%>%#Convert them to orientations between -90° & + 90°
  mutate(distrMean = ifelse(distrMean< -90, distrMean + 180,distrMean))%>%
  mutate(distrMean = ifelse(distrMean> 90, distrMean - 180, distrMean))%>%
  mutate(distrMean = ifelse(distrMean> 90, distrMean - 180, distrMean))%>%
  mutate(targetOri = ifelse(targetOri > 90, targetOri - 180, targetOri))%>%
  mutate(targetOri = ifelse(targetOri < -90, targetOri + 180, targetOri))%>%
  mutate(targetOri = ifelse(targetOri > 90, targetOri - 180, targetOri))%>%
  mutate(targetOri = ifelse(targetOri > 90, targetOri - 180, targetOri))


```


##Scale variables
```{r}
df_filter <- df_filter %>% 
  group_by(subjectId) %>% 
  mutate(rt_z = scale(rt), 
         ctpd_z = scale(ctpd),
         ctpd_z2 = scale(ctpd^2), #Quadratic predictors
         cdpt_z = scale(cdpt),
         ctpt_z = scale(ctpt), 
         ctpt_z2 = scale(ctpt^2),
         cdpd_z=scale(cdpd),
         abs_ctpd_z = scale(abs_ctpd),
         abs_ctpt_z = scale(abs_ctpt),
         abs_cdpd_z=scale(abs_cdpd),
         targetDist_ang_z_2 = scale(targetDist_ang^2))

```

##Check distribution of variables (abs_cdpt, abs_ctpd, abs_ctpt)
```{r}
ggplot(df_filter,aes(cdpt)) +geom_histogram(binwidth = 5) 
ggplot(df_filter,aes(ctpd)) +geom_histogram(binwidth = 5) 
ggplot(df_filter,aes(ctpt)) +geom_histogram(binwidth = 5) 
ggplot(df_filter,aes(cdpd)) +geom_histogram(binwidth = 5)
ggplot(df_filter,aes(targetOri)) +geom_histogram(binwidth = 5)
ggplot(df_filter,aes(targetDist_ang)) +geom_histogram(binwidth = 5)

df_filter %>%
  filter(correct==1) %>%
  filter(dsd == 5)%>%
  ggplot(aes(distrMean)) + geom_histogram(binwidth = 5)

```
## Account for circularity (For LOESS function) (from Andrey, see Word doc 'Andrey_on_circularity)
```{r}
##ACCOUNT FOR CIRCULARITY
data1<-filter(df_filter,ctpd< -60)
data1 <- data1 %>% mutate(ctpd = ctpd + 180)
data2<-filter(df_filter,ctpd> 60)
data2 <- data2 %>% mutate(ctpd = ctpd - 180)
df_filter_circ <-rbind(df_filter,data1,data2)

##ACCOUNT FOR CIRCULARITY
data1<-df_filter[df_filter$cdpd<-60,]
data1 <- data1 %>% mutate(cdpd = cdpd + 180)
data2<-df_filter[df_filter$cdpd>60,]
data2 <- data2 %>% mutate(cdpd = cdpd - 180)
df_filter_circ_cdpd <-rbind(df_filter,data1,data2)

```
## Make factors 
```{r}
df_filter$subjectId=factor(df_filter$subjectId)
df_filter$session=factor(df_filter$session)
df_filter$dsd = factor(df_filter$dsd)

df_filter_circ$subjectId=factor(df_filter_circ$subjectId)
df_filter_circ$session=factor(df_filter_circ$session)
df_filter_circ$dsd = factor(df_filter_circ$dsd)
```


## Check distributions of RTs and remove outliers (rt > 3*sd or rt<100ms)
```{r}

#Distribution of rts per participant with outliers
df_filter %>%
  filter(correct==1) %>%
  ggplot(., aes(subjectId,rt)) + geom_boxplot()

mean = mean(df_filter$rt)
sd = sd(df_filter$rt)
upper_limit = mean+ 3*sd

freq_with_outliers <- df_filter%>%group_by(subjectId,group)%>%summarise(n=n()) 
df_filter <- filter(df_filter,rt<upper_limit)
df_filter <- filter(df_filter,rt>100)
freq_without_outliers <- df_filter%>%group_by(subjectId,group)%>%summarise(n=n())
#Distribution of rts per participant without outliers
df_filter %>%
  filter(correct==1) %>%
  ggplot(., aes(subjectId,rt)) + geom_boxplot() + theme(axis.text.x = element_text(angle = 45, hjust = 1))

#Percentage of trials lost per group?
trials_lost <- cbind(freq_with_outliers,freq_without_outliers)
trials_lost <-trials_lost %>% mutate(lost_trials = n-n1)
trials_lost %>% group_by(group) %>% summarise(tot_trials = sum(n), n1= sum(n1),tot_lost_trials = sum(lost_trials), perc = (tot_lost_trials/tot_trials)*100 )

```



# Overall task performance 
##Mean and SD of RTs and accuracy per distribution type and range

```{r plot_stuff, fig.width=10, fig.height=5, fig.path='figures/', dev=c('png', 'pdf')}}

RTmeans_condition<- df_filter %>%
  filter(correct==1) %>% #only for correct responses
  group_by(subjectId,dtype,dsd,group) %>%
  summarise(mean_rt=mean(rt),sd_rt=sd(rt), mean_log_rt = mean(log_rt), sd_log_rt=sd(log_rt))

accmeans_condition<- df_filter %>%
  group_by(group,subjectId,dtype,dsd) %>%
  summarise(mean_acc=mean(correct),sd_acc=sd(correct))

means_condition <- RTmeans_condition%>%right_join(accmeans_condition, by=c("group","subjectId","dtype","dsd")) #RT and accuracy together

#summary table per group per condition
means_condition %>%
  group_by(group,dsd) %>%
  summarise(count = n(),acc=mean(mean_acc), sd_acc = sd(mean_acc), rt = mean(mean_rt), sd_rt=sd(mean_rt))

#Summary table per condition
means_condition %>%
  group_by(dsd) %>%
  summarise(count = n(),acc=mean(mean_acc), sd_acc = sd(mean_acc), rt = mean(mean_rt), sd_rt=sd(mean_rt))

#Plot RT data and acc data
plot_RT <- ggboxplot(means_condition, x = "dsd", y = "mean_rt", color = "group", add= "jitter", legend = "right", ylab="Mean Reaction Time (ms)", xlab = "Distractor Distribution SD" ) + scale_color_manual(values=c("darkorange", "darkslategrey"))+ scale_x_discrete( limits=c("5","10"))
#+ ggtitle("Mean Reaction Time per Group and per Condition") +theme(plot.title = element_text(hjust = 0.5))

plot_acc<- ggboxplot(means_condition, x = "dsd", y = "mean_acc", color = "group", add= "jitter", legend = "right", ylab="Mean Accuracy", xlab = "Distractor Distribution SD" )+ scale_color_manual(values=c("darkorange", "darkslategrey")) + scale_x_discrete( limits=c("5","10"))
# ggtitle("Mean Accuracy per Group and per Condition")+theme(plot.title = element_text(hjust = 0.5))
  
#Together in one figure with labels
plot_grid(plot_RT, plot_acc, labels = "AUTO")

```

## One-way repeated measures ANOVA: DV = RT; IV within = dsd
```{r}
##linear mixed model with DV = RT, IV within = dsd
lmer_rt<-lmer(log_rt ~ dsd * group + (dsd|subjectId), REML=F,  data = df_filter)
summary(lmer_rt)


#general linear mixed model with DV = correct, IV within = dsd
glmer_acc<- glmer(correct ~ dsd * group +(dsd|subjectId), family = binomial, data = df_filter)
summary(glmer_acc)
```

##Bayesian Analysis (based on how Charlote did it in https://www.ncbi.nlm.nih.gov/pubmed/30650436)
```{r}
bf_rt <- generalTestBF(log_rt ~ group * dsd + subjectId, data = as.data.frame(df_filter), 
                    whichRandom = "subjectId", neverExclude = "subjectId",whichModels = "withmain")
bf_df_rt <- as.data.frame(bf_rt)
bf_sorted_rt <- sort(bf_rt/ max(bf_rt))
bf_sorted_df_rt <- as.data.frame(bf_sorted_rt)
bf_sorted_df_rt$bfs <- (1/bf_sorted_df_rt$bf)
print(bf_sorted_df_rt)
bf_acc <- generalTestBF(correct ~ group * dsd + subjectId, data = as.data.frame(df_filter), 
                    whichRandom = "subjectId", neverExclude = "subjectId",whichModels = "withmain")
bf_df_acc <- as.data.frame(bf_acc)
bf_sorted_acc <- sort(bf_acc/ max(bf_acc))
bf_sorted_df_acc <- as.data.frame(bf_sorted_acc)
bf_sorted_df_acc$bfs <- (1/bf_sorted_df_acc$bf)
print(bf_sorted_df_acc)
```


#Repetition effects?
##RT & accuracy Plots

```{r}

RT_trial <- df_filter %>%
  filter(correct==1) %>% #only correct responses
  filter(previous_correct == 1)  %>% #only when previous trial was correct (post-error slowdown)
  filter(dsd==10) %>% #prime trials
  group_by(subjectId, group, dsd,trialN) %>% 
  summarise(mean_rt=mean(rt),sd_rt=sd(rt), mean_log_rt=mean(log_rt), sd_log_rt = sd(log_rt))

#Plot RTs over trials within prime streaks
RT_repetition_plot<- ggplot(RT_trial,aes(x=as.factor(trialN),y=mean_rt, color = group)) +
geom_point(size=0.5, colour = "gray80") + #Individual data points 
geom_line(aes(group=subjectId), colour = "gray80") + #lines between individual data points
stat_summary(fun.y=base::mean, geom="point", size =3) + # points for means per group
stat_summary(fun.y=base::mean, geom="line",aes(group=group)) + #lines between points for means per group
stat_summary(fun.data = "mean_se", geom="errorbar", width = 0.2) + #Standard error errorbars
facet_grid(~group) +#Per group
xlab("Trial Number") + ylab("Mean Reaction Time (ms)") +    #axis titles
theme_classic() + 
scale_color_manual(values=c("darkorange", "darkslategrey")) + #colors
theme(plot.title = element_text(hjust = 0.5)) + # Center titles
scale_x_discrete(labels=c("0" = "1", "1" = "2", "2" = "3","3" = "4","4"= "5","5" = "6")) #Rename x-axis labels

#same for accuracy
acc_trial<- df_filter %>%
  filter(dsd== 10) %>%
  group_by(subjectId,group,trialN) %>%
  summarise(mean_acc=mean(correct),sd_acc=sd(correct))

acc_repetition_plot<-ggplot(acc_trial,aes(x=as.factor(trialN),y=mean_acc, color = group))+ geom_point(size=0.5, colour = "gray80")  + geom_line(aes(group=subjectId), colour = "gray80") + stat_summary(fun.y=base::mean, geom="point", size =3) + stat_summary(fun.y=base::mean, geom="line",aes(group=group)) + stat_summary(fun.data = "mean_se", geom="errorbar", width = 0.2) +  facet_grid(~group) +
  xlab("Trial Number") + ylab("Mean Accuracy")   + theme_classic() + scale_color_manual(values=c("darkorange", "darkslategrey"))+
  theme(plot.title = element_text(hjust = 0.5))+ scale_x_discrete(labels=c("0" = "1", "1" = "2",
                              "2" = "3","3" = "4","4"= "5","5" = "6"))

plot_grid(RT_repetition_plot, acc_repetition_plot, labels = "AUTO", align ='v', ncol=1)
ggsave("figs/repetitionprimestreaks.png", dpi = 800)

```
#Do it again without first trials after breaks - test to see wheter increased RT at first trial was because it was right after break.
```{r}
RT_trial <- df_filter %>%
  filter(!grepl(18, totBlockN), !grepl(36, totBlockN),!grepl(54, totBlockN),!grepl(72, totBlockN),!grepl(90, totBlockN),!grepl(108, totBlockN),!grepl(126, totBlockN),!grepl(144, totBlockN),!grepl(162, totBlockN),!grepl(180, totBlockN),!grepl(198, totBlockN),!grepl(216, totBlockN),!grepl(234, totBlockN),!grepl(252, totBlockN))%>%
  filter(correct==1) %>%
  filter(previous_correct == 1)  %>%
  filter(dsd==10) %>%
  group_by(subjectId, group, dsd,trialN) %>%
  summarise(mean_rt=mean(rt),sd_rt=sd(rt), mean_log_rt=mean(log_rt), sd_log_rt = sd(log_rt))

ggplot(RT_trial,aes(x=as.factor(trialN),y=mean_rt, color = group))+ geom_point(size=0.5, colour = "gray80")  + geom_line(aes(group=subjectId), colour = "gray80") + stat_summary(fun.y=base::mean, geom="point", size =3) + stat_summary(fun.y=base::mean, geom="line",aes(group=group)) + stat_summary(fun.data = "mean_se", geom="errorbar", width = 0.2) +  facet_grid(~group) +
    xlab("Trial Number") + ylab("Mean Reaction Time (ms)")   + theme_classic() + scale_color_manual(values=c("darkorange", "darkslategrey"))+
  theme(plot.title = element_text(hjust = 0.5))+ scale_x_discrete(labels=c("0" = "1", "1" = "2",
                              "2" = "3","3" = "4","4"= "5","5" = "6"))+ ggtitle("Mean Reaction Time within Prime Streaks over Trial Number - Without first trials after break") +theme(plot.title = element_text(hjust = 0.5))

acc_trial<- df_filter %>%
  filter(!grepl(18, totBlockN), !grepl(36, totBlockN),!grepl(54, totBlockN),!grepl(72, totBlockN),!grepl(90, totBlockN),!grepl(108, totBlockN),!grepl(126, totBlockN),!grepl(144, totBlockN),!grepl(162, totBlockN),!grepl(180, totBlockN),!grepl(198, totBlockN),!grepl(216, totBlockN),!grepl(234, totBlockN),!grepl(252, totBlockN))%>%
  filter(dsd== 10) %>%
  group_by(subjectId,group,trialN) %>%
  summarise(mean_acc=mean(correct),sd_acc=sd(correct))

ggplot(acc_trial,aes(x=as.factor(trialN),y=mean_acc, color = group))+ geom_point(size=0.5, colour = "gray80")  + geom_line(aes(group=subjectId), colour = "gray80") + stat_summary(fun.y=base::mean, geom="point", size =3) + stat_summary(fun.y=base::mean, geom="line",aes(group=group)) + stat_summary(fun.data = "mean_se", geom="errorbar", width = 0.2) +  facet_grid(~group) +
  xlab("Trial Number") + ylab("Mean Accuracy")   + theme_classic() + scale_color_manual(values=c("darkorange", "darkslategrey"))+
  theme(plot.title = element_text(hjust = 0.5))+ scale_x_discrete(labels=c("0" = "1", "1" = "2",
                              "2" = "3","3" = "4","4"= "5","5" = "6"))+ ggtitle("Mean Reaction Time within Prime Streaks over Trial Number - Without first trials after break") +theme(plot.title = element_text(hjust = 0.5))
```



## Significance test for RTs over trial number with Helmert Contrasts (lmer) 
```{r}
PRIME_TR <- df_filter %>%
  filter(correct==1) %>% #Only correct trials
  filter(previous_correct == 1) %>% #Previous trial correct to account for post-error slowdown
  filter(dsd==10) #Only prime trials

PRIME_TR$trialN = factor(PRIME_TR$trialN)

my.helmert = matrix(c(5,-1,-1,-1,-1,-1,0,4,-1,-1,-1,-1,0,0,3,-1,-1,-1,0,0,0,2,-1,-1,0,0,0,0,1,-1), ncol = 5) #Make my own helmert contrast matrix, because build-in version is actually reverse Helmert contrast

lmer_RT_TD<-lmer(log_rt ~ trialN * group + (trialN|subjectId), data= PRIME_TR, contrasts = list(trialN = my.helmert))
summary(lmer_RT_TD)

```

## Significance test for acc over trial number with Helmert Contrasts
```{r}
df_acc<- df_filter%>%
  filter(dsd== 10)%>%
  mutate(trialN = factor(trialN))

acc_trial$trialN = factor(acc_trial$trialN)

glmer_acc<-glmer(correct ~ trialN*group + (trialN|subjectId),family = binomial, data = df_acc,contrasts = list(trialN = my.helmert))
summary(glmer_acc)
```



##Inter-trial priming by previous target orientation in prime streaks?? 
```{r}
df_rt_ctpt_prime<- df_filter %>%
  filter(correct==1) %>%
  filter(dsd==10)%>%
  filter(trialN > 0) #not the first trial

df_rt_ctpt_prime %>%
  group_by(subjectId,group,ctpt) %>% #Rt for each ctpt per participant
  summarise(rt=mean(rt)) %>%
  ggplot(aes(ctpt,rt, color=group))  +geom_smooth(method='loess', aes(fill=group)) + theme_classic()+ scale_color_manual(values=c("darkorange", "darkslategrey"))+ xlab("CT-PT") + ylab("Mean Reaction Time (ms)") 

df_rt_ctpt_prime %>%
  group_by(subjectId,group,abs_ctpt) %>%
  summarise(rt=mean(rt)) %>%
  ggplot(aes(abs_ctpt,rt, color=group)) + geom_smooth(method='loess', aes(fill=group))  + theme_classic()+ scale_color_manual(values=c("darkorange", "darkslategrey"))


```
##Significance tests? 
```{r}
#Absolute difference between current target and previous target as predictor
lmer_rt_ctpt1 <- lmer(log_rt~ abs_ctpt_z*group + (abs_ctpt_z|subjectId), data=df_rt_ctpt_prime)
summary(lmer_rt_ctpt1)

#Difference between current target and previous target as quadratic predictor  
lmer_rt_ctpt2 <- lmer(log_rt~ ctpt_z2*group + (ctpt_z2|subjectId), data=df_rt_ctpt_prime)
summary(lmer_rt_ctpt2)

#Bayesian Analysis
bf_rt <- generalTestBF(log_rt ~ ctpt_z2 * group + subjectId, data = as.data.frame(df_rt_ctpt_prime), 
                    whichRandom = "subjectId", neverExclude = "subjectId")
bf_df_rt <- as.data.frame(bf_rt)
bf_sorted_rt <- sort(bf_rt/ max(bf_rt))
bf_sorted_df_rt <- as.data.frame(bf_sorted_rt)
bf_sorted_df_rt$bfs <- (1/bf_sorted_df_rt$bf)
print(bf_sorted_df_rt)


```

##plot loess function over distance between current target and the mean of previous distractor distribution
```{r}
# rt ~ ct-pd plot
ctpd_plot <-df_filter_circ%>%
  filter(correct==1) %>% #only RTs for correct responses
  filter(previous_correct ==1) %>% #Only after a correct trial
  filter(dsd==5) %>% #For test streaks with Gaussian distr
  filter(trialN == 0) %>%#Only first trial of test streak 
  ggplot(aes(x=ctpd,y=rt, color=group,show.legend = FALSE)) + geom_smooth(method = "loess", aes(fill = group,show.legend = FALSE)) +  xlab("CT-PD") + ylab("RT (ms)")  + scale_x_continuous(breaks = seq(-90,90, by=15), limits=c(-90,90))   + scale_color_manual(values=c("darkorange", "darkslategrey")) + geom_vline(xintercept = 0) + theme(axis.text.x = element_text(angle = 45, hjust = 1))

#Plot of distribution of distractors
distribution_plot <- ggplot(data = data.frame(x = c(-90, 90)), aes(x)) +
  stat_function(fun = dnorm, n = 101, args = list(mean = 0, sd = 10))  + scale_x_continuous(breaks = seq(-90,90, by=15), limits=c(-90,90))+  xlab("CT-PD")+ geom_vline(xintercept = 0)+ ylab("Distr. Prob.")

# rt ~ absolute ct-pd plot
abs_ctpd_plot <-df_filter_circ %>%
  mutate(abs_ctpd = abs(ctpd)) %>%
  filter(correct==1) %>% #only RTs for correct responses
  filter(previous_correct ==1) %>% #Only after a correct trial
  filter(dsd==5) %>% #For test streaks with Gaussian distr
  filter(trialN == 0) %>% #Only first trial of test streak 
  ggplot(aes(x=abs_ctpd,y=rt,color=group)) + geom_smooth(method = "loess", aes(fill = group)) + scale_x_continuous(breaks = seq(0,90, by=15), limits=c(0,90)) + xlab("absolute CT-PD") + ylab("Mean Raction Time (ms)")   + scale_color_manual(values=c("darkorange", "darkslategrey"))

#Plot of half distribution of distractors
half_distribution_plot <- ggplot(data = data.frame(x = c(-90, 90)), aes(x)) +
  stat_function(fun = dnorm, n = 101, args = list(mean = 0, sd = 10))  + scale_x_continuous(breaks = seq(-90,90, by=15), limits=c(0,90))+  xlab("CT-PD")+ ylab("Distr. Prob.")



plot_grid(ctpd_plot, abs_ctpd_plot,labels = "auto")
ggsave("plot1.png", width = 30, height = 20, units = "cm", dpi = 800)
plot_grid(ctpd_plot + theme(legend.position="none"), distribution_plot,ncol=1,align = 'v')
ggsave("plot2.png", width = 10, height = 20, units = "cm", dpi = 800)
plot_grid(abs_ctpd_plot + theme(legend.position="none"), half_distribution_plot,ncol=1,align = 'v')
ggsave("plot3.png", width = 10, height = 20, units = "cm", dpi = 800)
```



##Different visualization: RTs over 10 ° CTPD bins

```{r}

df_steps<-df_filter %>%
  mutate(abs_ctpd = abs(ctpd)) %>%
  filter(correct==1) %>% #only RTs for correct responses
  filter(previous_correct ==1) %>% #Only after a correct trial
  filter(dsd==5) %>% #For test streaks with Gaussian distr
  filter(trialN == 0) %>% #Only first trial of test streak 
  group_by(subjectId,group,abs_ctpd) %>%
  summarise(rt=mean(rt), log_rt=mean(log_rt), rt_z = mean(rt_z), totBlockN=totBlockN)

#make bins
df_steps$step_ctpd[df_steps$abs_ctpd< 11] <- "0-10"
df_steps$step_ctpd[df_steps$abs_ctpd> 10 & df_steps$abs_ctpd< 21] <- "10-20"
df_steps$step_ctpd[df_steps$abs_ctpd> 20 & df_steps$abs_ctpd< 31] <- "20-30"
df_steps$step_ctpd[df_steps$abs_ctpd> 30 & df_steps$abs_ctpd< 41] <- "30-40"
df_steps$step_ctpd[df_steps$abs_ctpd> 40 & df_steps$abs_ctpd< 51] <- "40-50"
df_steps$step_ctpd[df_steps$abs_ctpd> 50 & df_steps$abs_ctpd< 61] <- "50-60"
df_steps$step_ctpd[df_steps$abs_ctpd> 60 & df_steps$abs_ctpd< 71] <- "60-70"
df_steps$step_ctpd[df_steps$abs_ctpd> 70 & df_steps$abs_ctpd< 81] <- "70-80"
df_steps$step_ctpd[df_steps$abs_ctpd> 80 & df_steps$abs_ctpd< 91] <- "80-90"
df_steps$step_ctpd[df_steps$abs_ctpd> 90 ] <- "90-100"

df_steps$step_ctpd = as.factor(df_steps$step_ctpd)

df_steps_plot <- df_steps%>%
  filter(step_ctpd != "90 - 100")%>%
  group_by(subjectId,step_ctpd, group)%>%
  summarise(rt = mean(rt))%>%
  ggplot(aes(x=step_ctpd,y=rt, color = group)) + stat_summary(fun.y=base::mean, geom="point", size =3) + stat_summary(fun.y=base::mean, geom="line")+ stat_summary(fun.y=base::mean, geom="line",size=1.5, aes(group = group))+ stat_summary(fun.data = "mean_se", geom="errorbar", width = 0.2)  + theme_classic() + xlab("Absolute CT-PD") + ylab("Mean Reaction Time (ms)")  + scale_color_manual(values=c("darkorange", "darkslategrey")) + theme(axis.text.x = element_text(angle = 45, hjust = 1))
plot_grid(ctpd_plot,df_steps_plot,labels = "AUTO")

#+ ggtitle("RT of correct answers plotted over absolute CT-PD") +theme(plot.title = element_text(hjust = 0.5))
```
#Make differently sized bins in line with bins from which the orientations are sampled in the experiment.
```{r}

df_steps<-df_filter %>%
  mutate(abs_ctpd = abs(ctpd)) %>%
  filter(correct==1) %>% #only RTs for correct responses
  filter(previous_correct ==1) %>% #Only after a correct trial
  filter(dsd==5) %>% #For test streaks with Gaussian distr
  filter(trialN == 0) #%>% #Only first trial of test streak 
  #group_by(subjectId,group,abs_ctpd) %>%
  #summarise(rt=mean(rt), log_rt=mean(log_rt), totBlockN=totBlockN)


df_steps$step_ctpd[df_steps$abs_ctpd< 5] <- "0-5"
df_steps$step_ctpd[df_steps$abs_ctpd> 4 & df_steps$abs_ctpd< 15] <- "05-15"
df_steps$step_ctpd[df_steps$abs_ctpd> 14 & df_steps$abs_ctpd< 25] <- "15-25"
df_steps$step_ctpd[df_steps$abs_ctpd> 24 & df_steps$abs_ctpd< 35] <- "25-35"
df_steps$step_ctpd[df_steps$abs_ctpd> 34 & df_steps$abs_ctpd< 50] <- "35-50"
df_steps$step_ctpd[df_steps$abs_ctpd> 49 & df_steps$abs_ctpd< 70] <- "50-70"
df_steps$step_ctpd[df_steps$abs_ctpd> 69 ] <- "70-90"


df_steps$step_ctpd = as.factor(df_steps$step_ctpd)

df_steps_plot <- df_steps%>%
  group_by(subjectId,step_ctpd, group)%>%
  summarise(rt = mean(rt))%>%
  ggplot(aes(x=step_ctpd,y=rt, color = group)) + stat_summary(fun.y=base::mean, geom="point", size =3) + stat_summary(fun.y=base::mean, geom="line")+ stat_summary(fun.y=base::mean, geom="line",size=1.5, aes(group = group))+ stat_summary(fun.data = "mean_se", geom="errorbar", width = 0.2)  + theme_classic() + xlab("Absolute CT-PD") + ylab("Mean Reaction Time (ms)")  + scale_color_manual(values=c("darkorange", "darkslategrey"))
df_steps_plot

#plot_grid(ctpd_plot,df_steps_plot,labels = "AUTO")

lmer_RT_step<-df_steps%>%
  lmer(log_rt ~ step_ctpd * group + (step_ctpd|subjectId),REML=F,control = lmerControl(optimizer ="Nelder_Mead"), data= .)
summary(lmer_RT_step)

df_RT_abs_ctpd<- df_filter %>%
  filter(correct==1) %>% #only RTs for correct responses
  filter(previous_correct ==1) %>% #Only after a correct trial
  filter(dsd==5) %>% #For test streaks with Gaussian distr
  filter(trialN == 0)
```

##LMER models of RTs over absolute CTPD 
```{r}
#LMER models
df_RT_abs_ctpd<- df_filter %>%
  filter(correct==1) %>% #only RTs for correct responses
  filter(previous_correct ==1) %>% #Only after a correct trial
  filter(dsd==5) %>% #For test streaks with Gaussian distr
  filter(trialN == 0)

df_RT_abs_ctpd$in_range[df_RT_abs_ctpd$abs_ctpd< 31] <- 1
df_RT_abs_ctpd$in_range[df_RT_abs_ctpd$abs_ctpd> 30] <- 0


  
lmer_RT<-lmer(rt ~ abs_ctpd_z*group + (abs_ctpd_z|subjectId) ,  REML=F, data = df_RT_abs_ctpd[df_RT_abs_ctpd$in_range == 1, ])
summary(lmer_RT)


lmer_RT<-lmer(rt ~ abs_ctpd_z*group + (abs_ctpd_z|subjectId) ,  REML=F, data = df_RT_abs_ctpd)
summary(lmer_RT)



#Include cd-pd (current distribution mean and previous distribution mean difference) and ct_pt current target and previous target ori as predictors
# lmer_RT_cdpt_ctpd<-lmer(rt ~ abs_ctpd_z + abs_cdpd_z + abs_ctpt_z +  group + (abs_ctpd_z|subjectId)+ (abs_ctpt_z|subjectId) + (abs_cdpd_z|subjectId) , REML=F, data = df_RT_abs_ctpd)
# summary(lmer_RT_cdpt_ctpd)

# bf_rt <- generalTestBF(log_rt ~ abs_ctpt_z * abs_ctpd_z * abs_cdpd_z* group + subjectId, data = as.data.frame(df_RT_abs_ctpd), 
#                     whichRandom = "subjectId", neverExclude = "subjectId",whichModels = "withmain")
# bf_df_rt <- as.data.frame(bf_rt)
# bf_sorted_rt <- sort(bf_rt/ max(bf_rt))
# bf_sorted_df_rt <- as.data.frame(bf_sorted_rt)
# bf_sorted_df_rt$bfs <- (1/bf_sorted_df_rt$bf)
# print(bf_sorted_df_rt)

#Segmented regression (like in Andrey's papers) for ASD group
df_RT_abs_ctpd_ASD <- df_RT_abs_ctpd %>%filter(group == 'ASD')
lm_RT_ASD<-lm(rt ~ abs_ctpd ,  data = df_RT_abs_ctpd_ASD)
#summary(lm_RT_ASD)
segASD = segmented(obj=lm_RT_ASD,seg.Z=~abs_ctpd, control=seg.control(), model = TRUE)
summary(segASD)

davies.test(lm_RT_ASD,seg.Z=~abs_ctpd)

#Segmented regression (like in Andrey's papers) for TD group
df_RT_abs_ctpd_TD <- df_RT_abs_ctpd %>%filter(group == 'TD')
lm_RT_TD<-lm(rt ~ abs_ctpd ,  data = df_RT_abs_ctpd_TD)
segTD = segmented(obj=lm_RT_TD,seg.Z=~abs_ctpd, control=seg.control(), model = TRUE)
summary(segTD)
davies.test(lm_RT_TD,seg.Z=~abs_ctpd)



```

#Estimate slopes based on linear regressions per individual (I also did segmented regressions per individual, but was not possible)
```{r}
#Estimate slope of linear regression
est_bp<- function(x) {
  print(unique(x$subjectId))
  my.lm <- lm(rt ~ abs_ctpd, data=x )
  b1<-my.lm$coefficients[2]
  return(data.frame(s = unique(x$subjectId),slope = b1))    
}

#Estimate slope within range of previous distractor distribution for each participant
df_RT_abs_ctpd  %>% 
  filter(abs_ctpd < 31)%>%
  group_by(subjectId,group) %>% do(est_bp(.)) -> df_est_sl
df_est_sl$range <- "in"

#Violin plot of slopes in range per group
ggplot(df_est_sl, aes(group,slope)) + geom_violin() + stat_summary(fun.y=base::mean, geom="point", size =3)+ stat_summary(fun.data = "mean_se", geom="errorbar", width = 0.2) + scale_color_manual(values=c("darkorange", "darkslategrey"))
t.test(df_est_sl$slope~df_est_sl$group)

#Estimate slope outside range of previous distractor distribution for each participant
df_RT_abs_ctpd  %>% 
  filter(abs_ctpd > 30)%>%
  group_by(subjectId,group) %>% do(est_bp(.)) -> df_est_sl_out
df_est_sl_out$range <- "out"

#Violin plot of slopes outside range per group
ggplot(df_est_sl_out, aes(group,slope)) + geom_violin() + stat_summary(fun.y=base::mean, geom="point", size =3)+ stat_summary(fun.data = "mean_se", geom="errorbar", width = 0.2) + scale_color_manual(values=c("darkorange", "darkslategrey"))
t.test(df_est_sl$slope~df_est_sl$group)

#Plot slopes in compared to outside range per group
df_est_sl<-rbind(df_est_sl,df_est_sl_out)
df_est_sl$range <- as.factor(df_est_sl$range)
ggplot(df_est_sl, aes(range,slope, color=group)) + geom_point(aes(group = group)) + stat_summary(fun.y=base::mean, geom="point", size =3)+ stat_summary(fun.data = "mean_se", geom="errorbar", width = 0.2) + scale_color_manual(values=c("darkorange", "darkslategrey"))

lmer_slope<-lmer(slope ~ range+group + (range|subjectId) ,  REML=F, data = df_est_sl)
summary(lmer_slope)
```

##Inter-trial priming by previous target orientation in test streaks?
```{r}
#Make plot
df_filter %>%
  filter(correct==1) %>%
  filter(previous_correct ==1) %>%
  filter(dsd==5)%>%
  filter(trialN == 0)%>%
  group_by(subjectId,group,ctpt) %>%
  summarise(rt=mean(rt)) %>%
  ggplot(aes(ctpt,rt, color=group)) + geom_smooth(method='loess') + facet_grid(~group) + theme_classic()+ scale_color_manual(values=c("darkorange", "darkslategrey"))

#Make datafile to do significance tests
df_rt_ctpt_test<- df_filter %>%
  filter(correct==1) %>%
  filter(previous_correct ==1)%>%
  filter(dsd==5)%>%
  filter(trialN == 0)
#Model with ctpt as linear predictor  
lmer_rt_ctpt1 <- lmer(rt_z~ ctpt_z2*group + (ctpt_z2|subjectId), data=df_rt_ctpt_test)
summary(lmer_rt_ctpt1)
#Model with ct-pd as quadratic predictor  
lmer_rt_ctpt2 <- lmer(rt_z~ ctpd_z2*group + (ctpd_z2|subjectId), data=df_rt_ctpt_test)
summary(lmer_rt_ctpt2)

#Model with ct-pd & ct-pt as quadratic predictors 
lmer_rt_ctpt3 <- lmer(rt_z~ ctpt_z2*ctpd_z2*group + (ctpt_z2|subjectId)+ (ctpd_z2|subjectId), data=df_rt_ctpt_test)
summary(lmer_rt_ctpt3)

#Compare three models
anova(lmer_rt_ctpt1,lmer_rt_ctpt2,lmer_rt_ctpt3)

#Compare models with Bayesian analysis
bf_rt <- generalTestBF(log_rt ~ ctpt_z2 * ctpd_z2* group + subjectId, data = as.data.frame(df_rt_ctpt_test), 
                    whichRandom = "subjectId", neverExclude = "subjectId")
bf_df_rt <- as.data.frame(bf_rt)
bf_sorted_rt <- sort(bf_rt/ max(bf_rt))
bf_sorted_df_rt <- as.data.frame(bf_sorted_rt)
bf_sorted_df_rt$bfs <- (1/bf_sorted_df_rt$bf)
print(bf_sorted_df_rt)

```

##Difference in RTs between test trials where target orientation lies within the range of the previous distractor distribution vs out the range of the previous distractor distribution 
```{r}
df_steps<-df_filter %>%
  mutate(abs_ctpd = abs(ctpd)) %>%
  filter(correct==1) %>% #only RTs for correct responses
  filter(previous_correct ==1) %>% #Only after a correct trial
  filter(dsd==5) %>% #For test streaks with Gaussian distr
  filter(trialN == 0) %>% #Only first trial of test streak 
  group_by(subjectId,group,abs_ctpd) %>%
  summarise(rt=mean(rt), log_rt=mean(log_rt), rt_z = mean(rt_z), totBlockN=totBlockN)

df_steps$in_range[df_steps$abs_ctpd< 31] <- "in_range"
df_steps$in_range[df_steps$abs_ctpd> 30] <- "out_range"
df_steps$in_range = as.factor(df_steps$in_range)

inrange_plot<-df_steps%>%
  group_by(subjectId,in_range,group)%>%
  summarise(n=n(),rt=mean(rt)) %>%
  ggplot(aes(in_range,rt, color=group)) + geom_point(size=0.5, colour = "gray80")  + geom_line(aes(group=subjectId), colour = "gray80") + stat_summary(fun.y=base::mean, geom="point", size =3) + stat_summary(fun.y=base::mean, geom="line",aes(group=group)) + stat_summary(fun.data = "mean_se", geom="errorbar", width = 0.2) +  facet_grid(~group)+ theme_classic() + scale_color_manual(values=c("darkorange", "darkslategrey"))+ xlab("In or out range") + ylab("Mean Reaction Time (ms)") + scale_x_discrete(labels=c("in_range" = "in range", "out_range" = "out range"))
#plot_grid(ctpd_plot, abs_ctpd_plot,df_steps_plot,inrange_plot,labels = "AUTO")

lmer_rt_in_out <- lmer(log_rt ~ in_range * group + (in_range|subjectId) , REML=F,  data = df_steps)
summary(lmer_rt_in_out)

```

# Correlations with Questionnaire Data
##Import demographics table
```{r}
demo_ASD <- read_csv("Data/deelnemers_ASD.csv")
demo_TD <- read_csv("Data/CONTROLEdeelnemers.csv")
demo_ASD <- select(demo_ASD, SubjectId,leeftijd, Geslacht, VIQ, PIQ,SRS_TOTAAL,SRS_SB, SRS_SCOG, SRS_SCOM, SRS_SM, SRS_AP, IU,CBCL,SP, ADOS,ADOS_SA,ADOS_BRG)
demo_ASD <- filter(demo_ASD,!is.na(SubjectId))
demo_ASD$SubjectId = as.factor(demo_ASD$SubjectId)

demo_ASD$Group <- 'ASD'
demo_ASD <- filter(demo_ASD,!grepl("002",SubjectId))
demo_TD <- select(demo_TD, SubjectId,leeftijd, Geslacht, VIQ, PIQ,SRS_TOTAAL,SRS_SB, SRS_SCOG, SRS_SCOM, SRS_SM, SRS_AP,IU,CBCL,SP)
demo_TD <- filter(demo_TD,!grepl("316",SubjectId),!grepl("315",SubjectId),!grepl("322",SubjectId),!grepl("310",SubjectId),!grepl("321",SubjectId))
demo_TD$SubjectId = as.factor(demo_TD$SubjectId)
demo_TD$Group <- 'TD'
demo_TD$SP = as.integer(demo_TD$SP)
  

demo<-bind_rows(demo_ASD,demo_TD)
demo <- demo%>%
  mutate(FIQ=((PIQ + VIQ)/2))%>%
  rename(subjectId=SubjectId)
demo$subjectId = as.factor(demo$subjectId)
demo$Group = factor(demo$Group)

df_filter_demo<- inner_join(df_filter,demo, by="subjectId")

length(unique(df_filter$subjectId)) - length(unique(df_filter_demo$subjectId))
unique(df_filter$subjectId)
```

## Correlations between rt's and acc and questionnaire data for whole group
```{r}
cor<-df_filter_demo %>%
     group_by(subjectId, group,dsd)%>%
     summarise(VIQ=mean(VIQ),PIQ=mean(PIQ),leeftijd=mean(leeftijd), rt=mean(rt), IU = mean(IU), SRS = mean(SRS_TOTAAL), acc = mean(correct), CBCL=mean(CBCL), SP = mean(SP))

#SRS
RT_SRS <- ggplot(cor,aes(SRS,rt)) + geom_point(aes(color=group)) + facet_grid(~dsd) +
    xlab("SRS") + ylab("Mean RT") + geom_smooth(method = 'lm', color='black') + ggtitle("Mean RTs over SRS") +
  theme(plot.title = element_text(hjust = 1))  + theme_classic() + scale_color_manual(values=c("darkorange", "darkslategrey"))

acc_SRS<- ggplot(cor,aes(SRS,acc)) + geom_point(aes(color=group)) + facet_grid(~dsd) +
    xlab("SRS") + ylab("Mean Accuracy") + ggtitle("Mean accuracy over SRS") +
  theme(plot.title = element_text(hjust = 1))  + theme_classic() + scale_color_manual(values=c("darkorange", "darkslategrey"))+ geom_smooth(method = 'lm', color='black')

#SP
RT_SP <- ggplot(cor,aes(SP,rt)) + geom_point(aes(color=group)) + facet_grid(~dsd) +
    xlab("SP") + ylab("Mean RT") + ggtitle("Mean RTs over SP") +
  theme(plot.title = element_text(hjust = 1))  + theme_classic() + scale_color_manual(values=c("darkorange", "darkslategrey"))+ geom_smooth(method = 'lm', color='black')

acc_SP <- ggplot(cor,aes(SP,acc)) + geom_point(aes(color=group)) + facet_grid(~dsd) +
    xlab("SP") + ylab("Mean Accuracy") + ggtitle("Mean accuracy over SP") +
  theme(plot.title = element_text(hjust = 1))  + theme_classic() + scale_color_manual(values=c("darkorange", "darkslategrey"))+ geom_smooth(method = 'lm', color='black')

#IU
RT_IU <-ggplot(cor,aes(IU,rt)) + geom_point(aes(color=group)) + facet_grid(~dsd) +
    xlab("IU") + ylab("Mean RT") + ggtitle("Mean RTs over IU") +
  theme(plot.title = element_text(hjust = 1))  + theme_classic() + scale_color_manual(values=c("darkorange", "darkslategrey"))+ geom_smooth(method = 'lm', color='black')

acc_IU <- ggplot(cor,aes(IU,acc)) + geom_point(aes(color=group)) + facet_grid(~dsd) +
    xlab("IU") + ylab("Mean Accuracy") + ggtitle("Mean accuracy over IU") +
  theme(plot.title = element_text(hjust = 1))  + theme_classic() + scale_color_manual(values=c("darkorange", "darkslategrey"))+ geom_smooth(method = 'lm', color='black')

#Age
RT_age <- ggplot(cor,aes(leeftijd,rt)) + geom_point(aes(color=group)) + facet_grid(~dsd) +
    xlab("age") + ylab("Mean RT") + ggtitle("Mean RTs over age") +
  theme(plot.title = element_text(hjust = 1))  + theme_classic() + scale_color_manual(values=c("darkorange", "darkslategrey"))+ geom_smooth(method = 'lm', color='black')

acc_age <- ggplot(cor,aes(leeftijd,acc)) + geom_point(aes(color=group)) + facet_grid(~dsd) +
    xlab("age") + ylab("Mean Accuracy") + ggtitle("Mean accuracy over age") +
  theme(plot.title = element_text(hjust = 1))  + theme_classic() + scale_color_manual(values=c("darkorange", "darkslategrey"))+ geom_smooth(method = 'lm', color='black')

#Verbal IQ
RT_VIQ <- ggplot(cor,aes(VIQ,rt)) + geom_point(aes(color=group)) + facet_grid(~dsd) +
    xlab("VIQ") + ylab("Mean RT") + ggtitle("Mean RTs over VIQ") +
  theme(plot.title = element_text(hjust = 1))  + theme_classic() + scale_color_manual(values=c("darkorange", "darkslategrey"))+ geom_smooth(method = 'lm', color='black')

acc_VIQ <- ggplot(cor,aes(VIQ,acc)) + geom_point(aes(color=group)) + facet_grid(~dsd) +
    xlab("VIQ") + ylab("Mean Accuracy") + ggtitle("Mean accuracy over VIQ") +
  theme(plot.title = element_text(hjust = 1))  + theme_classic() + scale_color_manual(values=c("darkorange", "darkslategrey"))+ geom_smooth(method = 'lm', color='black')

#Performal IQ
RT_PIQ  <- ggplot(cor,aes(PIQ,rt)) + geom_point(aes(color=group)) + facet_grid(~dsd) +
    xlab("PIQ") + ylab("Mean RT") + ggtitle("Mean RTs over PIQ") +
  theme(plot.title = element_text(hjust = 1))  + theme_classic() + scale_color_manual(values=c("darkorange", "darkslategrey"))+ geom_smooth(method = 'lm', color='black')

acc_PIQ <- ggplot(cor,aes(PIQ,acc)) + geom_point(aes(color=group)) + facet_grid(~dsd) +
    xlab("PIQ") + ylab("Mean Accuracy") + ggtitle("Mean accuracy over PIQ") +
  theme(plot.title = element_text(hjust = 1))  + theme_classic() + scale_color_manual(values=c("darkorange", "darkslategrey"))+ geom_smooth(method = 'lm', color='black')

#Attention score
RT_CBCL <- ggplot(cor,aes(CBCL,rt)) + geom_point(aes(color=group)) + facet_grid(~dsd) +
    xlab("CBCL") + ylab("Mean RT") + ggtitle("Mean RTs over CBCL") +
  theme(plot.title = element_text(hjust = 1))  + theme_classic() + scale_color_manual(values=c("darkorange", "darkslategrey"))+ geom_smooth(method = 'lm', color='black')

acc_CBCL <- ggplot(cor,aes(CBCL,acc)) + geom_point(aes(color=group)) + facet_grid(~dsd) +
    xlab("CBCL") + ylab("Mean Accuracy") + ggtitle("Mean accuracy over CBCL") +
  theme(plot.title = element_text(hjust = 1))  + theme_classic() + scale_color_manual(values=c("darkorange", "darkslategrey"))+ geom_smooth(method = 'lm', color='black')

RT_SRS
RT_SP
RT_IU
RT_VIQ
RT_PIQ
RT_age
RT_CBCL

acc_SRS
acc_SP
acc_IU
acc_VIQ
acc_PIQ
acc_age
acc_CBCL

#Correlation tests per condition
cor_dsd_10<- cor %>% filter(dsd =='10') 
cor.test(cor_dsd_10$SRS,cor_dsd_10$rt)
cor_dsd_5<- cor %>% filter(dsd =='5') 
cor.test(cor_dsd_5$SRS,cor_dsd_5$rt)

cor.test(cor_dsd_10$rt,cor_dsd_10$IU)
cor.test(cor_dsd_5$rt,cor_dsd_5$IU)
cor.test(cor_dsd_10$rt,cor_dsd_10$SP)
cor.test(cor_dsd_5$rt,cor_dsd_5$SP)
cor.test(cor_dsd_10$rt,cor_dsd_10$leeftijd)
cor.test(cor_dsd_5$rt,cor_dsd_5$leeftijd)
cor.test(cor_dsd_10$rt,cor_dsd_10$PIQ)
cor.test(cor_dsd_5$rt,cor_dsd_5$PIQ)
cor.test(cor_dsd_10$rt,cor_dsd_10$VIQ)
cor.test(cor_dsd_5$rt,cor_dsd_5$VIQ)
cor.test(cor_dsd_10$rt,cor_dsd_10$CBCL)
cor.test(cor_dsd_5$rt,cor_dsd_5$CBCL)

#Bayesian Correlation tests
cor<-df_filter_demo %>%
     group_by(subjectId, group)%>%
     summarise(VIQ=mean(VIQ),PIQ=mean(PIQ),leeftijd=mean(leeftijd), rt=mean(rt), IU = mean(IU), SRS = mean(SRS_TOTAAL), acc = mean(correct), CBCL=mean(CBCL), SP = mean(SP))

bayes_cor.test(cor$SRS,cor$rt)
bayes_cor.test(cor$SRS,cor$acc)
bayes_cor.test(cor$IU,cor$rt)
bayes_cor.test(cor$IU,cor$acc)
bayes_cor.test(cor$leeftijd,cor$rt)
bayes_cor.test(cor$leeftijd,cor$acc)
bayes_cor.test(cor$PIQ,cor$rt)
bayes_cor.test(cor$PIQ,cor$acc)
bayes_cor.test(cor$VIQ,cor$rt)
bayes_cor.test(cor$VIQ,cor$acc)
bayes_cor.test(cor$CBCL,cor$rt)
bayes_cor.test(cor$CBCL,cor$acc)
bayes_cor.test(cor$SP,cor$rt)
bayes_cor.test(cor$SP,cor$acc)


```



#Calculate difference in RT and acc between first and subsequent trials per participant
```{r}
rt_difference<- RT_trial %>%
  select(subjectId,group, trialN,mean_rt)%>%
  spread(key = trialN, value = mean_rt)%>%
  rename(trial_0 = '0')%>%
  rename(trial_1 = '1')%>%
  rename(trial_2 = '2')%>%
  rename(trial_3 = '3')%>%
  rename(trial_4 = '4')%>%
  rename(trial_5 = '5')%>%
  mutate(average_trials = ((trial_1 + trial_2 + trial_3 + trial_4 + trial_5)/5)) %>% #average rt on 5 last trials
  mutate(difference_0_1 = trial_0 - trial_1)%>% # difference between first and second trial
  mutate(difference_0_av = trial_0 - average_trials) #difference between first and average rt of subsequent trials

ggboxplot(rt_difference, x = "group", y = "difference_0_av", color = "group", add= "jitter", legend = "right", ylab="Mean Difference in Reaction Time", xlab = "Group" ) + scale_color_manual(values=c("darkorange", "darkslategrey")) + ggtitle("Mean Difference of RT at First Trial and Average RT on Subsequent Trials") + theme(plot.title = element_text(hjust = 0.5))

ggboxplot(rt_difference, x = "group", y = "difference_0_1", color = "group", add= "jitter", legend = "right", ylab="Mean Difference in Reaction Time", xlab = "Group" ) + scale_color_manual(values=c("darkorange", "darkslategrey")) + ggtitle("Mean Difference of RT at First Trial and RT on Second Trial") + theme(plot.title = element_text(hjust = 0.5))

#same for accuracy
acc_difference<- acc_trial %>%
  select(subjectId,group, trialN,mean_acc)%>%
  spread(key = trialN, value = mean_acc)%>%
  rename(trial_0 = '0')%>%
  rename(trial_1 = '1')%>%
  rename(trial_2 = '2')%>%
  rename(trial_3 = '3')%>%
  rename(trial_4 = '4')%>%
  rename(trial_5 = '5')%>%
  mutate(average_trials = ((trial_1 + trial_2 + trial_3 + trial_4 + trial_5)/5)) %>%
  mutate(difference_0_1 = trial_0 - trial_1)%>%
  mutate(difference_0_av = trial_0 - average_trials)

ggboxplot(acc_difference, x = "group", y = "difference_0_av", color = "group", add= "jitter", legend = "right", ylab="Mean Difference in Accuracy", xlab = "Group" ) + scale_color_manual(values=c("darkorange", "darkslategrey")) + ggtitle("Mean Difference of acc at First Trial and Average acc on Subsequent Trials") + theme(plot.title = element_text(hjust = 0.5))

ggboxplot(acc_difference, x = "group", y = "difference_0_1", color = "group", add= "jitter", legend = "right", ylab="Mean Difference in Accuracy", xlab = "Group" ) + scale_color_manual(values=c("darkorange", "darkslategrey")) + ggtitle("Mean Difference of acc at First Trial and second trial") + theme(plot.title = element_text(hjust = 0.5))
df_difference<- inner_join(rt_difference,acc_difference, by="subjectId")
df_difference <- df_difference %>%
  rename(difference_0_av_rt = difference_0_av.x)%>%
  rename(difference_0_av_acc = difference_0_av.y)


```

##Inter-individual variability : Correlation of difference within prime streaks with questionnaire data
```{r}
rt_difference_demo<- inner_join(rt_difference,demo, by="subjectId")
bayes_cor.test(rt_difference_demo$difference_0_av,rt_difference_demo$SRS_TOTAAL)
bayes_cor.test(rt_difference_demo$difference_0_av,rt_difference_demo$SRS_SB)
bayes_cor.test(rt_difference_demo$difference_0_av,rt_difference_demo$SRS_SCOG)
bayes_cor.test(rt_difference_demo$difference_0_av,rt_difference_demo$SRS_SCOM)
bayes_cor.test(rt_difference_demo$difference_0_av,rt_difference_demo$SRS_SM)
bayes_cor.test(rt_difference_demo$difference_0_av,rt_difference_demo$SRS_AP)

bayes_cor.test(rt_difference_demo$difference_0_av,rt_difference_demo$IU)

bayes_cor.test(rt_difference_demo$difference_0_av,rt_difference_demo$ADOS)
bayes_cor.test(rt_difference_demo$difference_0_av,rt_difference_demo$ADOS_BRG)
bayes_cor.test(rt_difference_demo$difference_0_av,rt_difference_demo$ADOS_SA)

bayes_cor.test(rt_difference_demo$difference_0_av,rt_difference_demo$leeftijd)
bayes_cor.test(rt_difference_demo$difference_0_av,rt_difference_demo$SP)

diff_IU<-ggplot(rt_difference_demo, aes(IU,difference_0_av)) + geom_point(aes(color=group)) + geom_smooth(method = 'lm', color='black')+ scale_color_manual(values=c("darkorange", "darkslategrey"))

diff_SRS<-ggplot(rt_difference_demo, aes(SRS_TOTAAL,difference_0_av)) + geom_point(aes(color=group)) + geom_smooth(method = 'lm', color='black')+ scale_color_manual(values=c("darkorange", "darkslategrey"))

diff_SCOM<-ggplot(rt_difference_demo, aes(SRS_SCOM,difference_0_av)) + geom_point(aes(color=group)) + geom_smooth(method = 'lm', color='black')+ scale_color_manual(values=c("darkorange", "darkslategrey"))

diff_ADOS<-ggplot(rt_difference_demo, aes(ADOS,difference_0_av)) + geom_point(aes(color=group)) + geom_smooth(method = 'lm', color='black')+ scale_color_manual(values=c("darkorange", "darkslategrey"))

diff_IQ<-ggplot(rt_difference_demo, aes(FIQ,difference_0_av)) + geom_point(aes(color=group)) + geom_smooth(method = 'lm', color='black')+ scale_color_manual(values=c("darkorange", "darkslategrey"))
diff_age<-ggplot(rt_difference_demo, aes(leeftijd,difference_0_av)) + geom_point(aes(color=group)) + geom_smooth(method = 'lm', color='black')+ scale_color_manual(values=c("darkorange", "darkslategrey"))

plot_grid(diff_SRS, diff_SCOM,diff_ADOS, diff_IU)

diff_SP<-ggplot(rt_difference_demo, aes(SP,difference_0_1)) + geom_point(aes(color=group)) + geom_smooth(method = 'lm', color='black')+ scale_color_manual(values=c("darkorange", "darkslategrey"))


rt_difference_ASD<-  rt_difference_demo%>%filter(group == 'ASD')
ggplot(rt_difference_ASD, aes(IU,difference_0_1)) + geom_point()+ geom_smooth(method = 'lm', color='black')
cor.test(rt_difference_ASD$difference_0_1,rt_difference_ASD$IU)
```
##Correlation of difference within prime streaks with questionnaire data _ ACCURACY
```{r}
acc_difference_demo<- inner_join(acc_difference,demo, by="subjectId")
bayes_cor.test(acc_difference_demo$difference_0_av,acc_difference_demo$SRS_TOTAAL)
bayes_cor.test(acc_difference_demo$difference_0_av,acc_difference_demo$SRS_SB)
bayes_cor.test(acc_difference_demo$difference_0_av,acc_difference_demo$SRS_SCOG)
bayes_cor.test(acc_difference_demo$difference_0_av,acc_difference_demo$SRS_SCOM)
bayes_cor.test(acc_difference_demo$difference_0_av,acc_difference_demo$SRS_SM)
bayes_cor.test(acc_difference_demo$difference_0_av,acc_difference_demo$SRS_AP)

bayes_cor.test(acc_difference_demo$difference_0_av,acc_difference_demo$IU)

bayes_cor.test(acc_difference_demo$difference_0_av,acc_difference_demo$ADOS)
bayes_cor.test(acc_difference_demo$difference_0_av,acc_difference_demo$ADOS_BRG)
bayes_cor.test(acc_difference_demo$difference_0_av,acc_difference_demo$ADOS_SA)

bayes_cor.test(acc_difference_demo$difference_0_av,acc_difference_demo$leeftijd)
bayes_cor.test(acc_difference_demo$difference_0_av,acc_difference_demo$SP)

diff_IU<-ggplot(acc_difference_demo, aes(IU,difference_0_av)) + geom_point(aes(color=group)) + geom_smooth(method = 'lm', color='black')+ scale_color_manual(values=c("darkorange", "darkslategrey"))

diff_SRS<-ggplot(acc_difference_demo, aes(SRS_TOTAAL,difference_0_av)) + geom_point(aes(color=group)) + geom_smooth(method = 'lm', color='black')+ scale_color_manual(values=c("darkorange", "darkslategrey"))

diff_ADOS<-ggplot(acc_difference_demo, aes(ADOS,difference_0_av)) + geom_point(aes(color=group)) + geom_smooth(method = 'lm', color='black')+ scale_color_manual(values=c("darkorange", "darkslategrey"))

diff_IQ<-ggplot(acc_difference_demo, aes(FIQ,difference_0_av)) + geom_point(aes(color=group)) + geom_smooth(method = 'lm', color='black')+ scale_color_manual(values=c("darkorange", "darkslategrey"))
diff_age<-ggplot(acc_difference_demo, aes(leeftijd,difference_0_av)) + geom_point(aes(color=group)) + geom_smooth(method = 'lm', color='black')+ scale_color_manual(values=c("darkorange", "darkslategrey"))

plot_grid(diff_IQ,diff_age, diff_SRS, diff_ADOS, diff_IU)

acc_difference_ASD<-  acc_difference_demo%>%filter(group == 'ASD')
ggplot(acc_difference_ASD, aes(ADOS,difference_0_av)) + geom_point()+ geom_smooth(method = 'lm', color='black')
cor.test(acc_difference_ASD$difference_0_av,acc_difference_ASD$SRS_TOTAAL)
cor.test(acc_difference_ASD$difference_0_av,acc_difference_ASD$SRS_TOTAAL)
cor.test(acc_difference_ASD$difference_0_av,acc_difference_ASD$SRS_SB)
cor.test(acc_difference_ASD$difference_0_av,acc_difference_ASD$SRS_SCOG)
cor.test(acc_difference_ASD$difference_0_av,acc_difference_ASD$SRS_SCOM)
cor.test(acc_difference_ASD$difference_0_av,acc_difference_ASD$SRS_SM)
cor.test(acc_difference_ASD$difference_0_av,acc_difference_ASD$SRS_AP)

cor.test(acc_difference_ASD$difference_0_av,acc_difference_ASD$IU)

cor.test(acc_difference_ASD$difference_0_av,acc_difference_ASD$ADOS)
cor.test(acc_difference_ASD$difference_0_av,acc_difference_ASD$ADOS_BRG)
cor.test(acc_difference_ASD$difference_0_av,acc_difference_ASD$ADOS_SA)

cor.test(acc_difference_ASD$difference_0_av,acc_difference_ASD$leeftijd)
cor.test(acc_difference_ASD$difference_0_av,acc_difference_ASD$SP)

acc_difference_TD<-  acc_difference_demo%>%filter(group == 'TD')
ggplot(acc_difference_TD, aes(IU,difference_0_1)) + geom_point()+ geom_smooth(method = 'lm', color='black')
cor.test(acc_difference_TD$difference_0_av,acc_difference_TD$SRS_TOTAAL)
cor.test(acc_difference_TD$difference_0_av,acc_difference_TD$SRS_SB)
cor.test(acc_difference_TD$difference_0_av,acc_difference_TD$SRS_SCOG)
cor.test(acc_difference_TD$difference_0_av,acc_difference_TD$SRS_SCOM)
cor.test(acc_difference_TD$difference_0_av,acc_difference_TD$SRS_SM)
cor.test(acc_difference_TD$difference_0_av,acc_difference_TD$SRS_AP)

cor.test(acc_difference_TD$difference_0_av,acc_difference_TD$IU)
cor.test(acc_difference_TD$difference_0_av,acc_difference_TD$leeftijd)
cor.test(acc_difference_TD$difference_0_av,acc_difference_TD$SP)
```

##save datafile to csv
```{r}


write.csv(df_filter_demo, 'alldataDescr.csv')
```
